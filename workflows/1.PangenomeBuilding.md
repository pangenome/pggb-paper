# Pangenome building

Variables:

```shell
DIR_BASE=/lizardfs/guarracino/pggb-paper
DIR_GRAPHS=/lizardfs/guarracino/pggb-paper/graphs
DIR_GRAPHS_MC=/lizardfs/guarracino/pggb-paper/graphs_mc
DIR_EVALUATIONS=/lizardfs/guarracino/pggb-paper/evaluations
PATH_PANGENOMES_TSV=/lizardfs/guarracino/pggb-paper/data/pangenomes.tsv

PGGB=/home/guarracino/tools/pggb/pggb-13482bd06359a7ad8e3d3e0dd6eb6d9399f26046
ODGI=/home/guarracino/tools/odgi/bin/odgi-861b1c04f5622c5bb916a161c1abe812c213f1a5
WFMASH=/home/guarracino/tools/wfmash/build/bin/wfmash-0b191bb84ffdfd257354c1aa82a7f1e13dc536d0
RUN_GFA_2_EVALUATION=/lizardfs/guarracino/pggb-paper/scripts/gfa2evaluation.sh

# guix install python-scikit-learn python-seaborn
PANACUS=/home/guarracino/tools/panacus/target/release/panacus-bd492f54c05367d0fc5a2c3fb9bf23260ac8379e
PANACUS_VISUALIZE=/home/guarracino/tools/panacus/scripts/panacus-visualize.py

THREADS=48
```

## All species

Run `pggb`:

```shell
mkdir -p $DIR_GRAPHS
cd $DIR_GRAPHS

sed '1d' $PATH_PANGENOMES_TSV | sort -k 4n | while read f p s n k G POA O REF; do
  seq 1 1 | while read c; do
    echo $f $p $s $n $k $G $POA $O $REF $c;
    
    out=$(basename "$f" .fa.gz)_p$p.s$s.n$n.k$k.G$(echo $G | tr ',' '-').P$POA.O$(echo $O | sed 's/\.//g')_$c
    sbatch -c $THREADS -p 386mem -J $(basename "$f" .fa.gz) --wrap "hostname; cd /scratch; $PGGB -i $f -p $p -s $s -n $n -k $k -P $POA -O $O -G $G -t $THREADS -o $out; mv $out $DIR_GRAPHS/$out;"
  done
done

cd $DIR_GRAPHS
# Script to parse statistics
(echo dataset tool runtime_s memory_kb replicate | tr ' ' '\t'; grep 'wfmash-\|seqwish-\|smoothxg-\|odgi-\|gfaffix-' */*log -A 1  | grep 'wfmash::align' -v | grep '^--$' -v | python3 ../scripts/pggb_stats.py | awk -v OFS='\t' '{print($0, substr($1, length($1), 1))}') > runtime+memory.stats.tsv

awk 'BEGIN { FS="\t"; OFS="\t" } 
  NR>1 { runtime[$1,$5]+=$3; memory[$1,$5]=(memory[$1,$5]>$4)?memory[$1,$5]:$4 } 
  END { 
      print "dataset", "replicate", "total_runtime_m", "max_memory_kb"; 
      for (key in runtime) { 
          split(key, indices, SUBSEP); 
          print indices[1], indices[2], runtime[key]/60, memory[key] 
      } 
  }' runtime+memory.stats.tsv > runtime+memory.stats.grouped.tsv

cat runtime+memory.stats.tsv | grep -v 'odgi-viz\|odgi-layout\|odgi-draw' | awk 'BEGIN { FS="\t"; OFS="\t" } 
  NR>1 { runtime[$1,$5]+=$3; memory[$1,$5]=(memory[$1,$5]>$4)?memory[$1,$5]:$4 } 
  END { 
      print "dataset", "replicate", "total_runtime_m", "max_memory_kb"; 
      for (key in runtime) { 
          split(key, indices, SUBSEP); 
          print indices[1], indices[2], runtime[key]/60, memory[key] 
      } 
  }' > runtime+memory.stats.grouped.no-viz.tsv

#Old
#grep 'wfmash-\|seqwish-\|smoothxg-\|odgi-' hsapiens90.chr6.masked_p98.s10000.n90.k79.G700-900-1100.Pasm5.O0001/*log -A 1  | grep 'wfmash::align' -v | grep '^--$' -v | cut -f 1,2 -d ' ' | rev | cut -f 1 -d '/' | rev | sed 's/-[^ ]*//g' | sed 's/s user//g' | paste - - | sed 's/ \([[:alpha:]]\)/_\1/g' | column -t

# Risky verbose way
#ls */*log | while read f; do x=$(echo $f | cut -f 1 -d '.'); grep 'max memory' $f | head -n 4 | cut -f 7 -d ' ' | sed 's/s//g' | awk '{print($0/60/60)}' | paste - - - - | awk '{print($1,"wfmash-mapping", $2, #"wfmash-alignment",$3,"seqwish",$4,"smoothxg")}' | tr ' ' '\n' | paste - - | awk -v set=$x '{print($0,set)}' | column -t; done | column -t

sbatch -c 96 -p tux --job-name pggb-human-mouse --wrap "hostname; $PGGB -i /lizardfs/guarracino/pggb-paper/assemblies/grch38+mm39.fa.gz -o /lizardfs/guarracino/pggb-paper/graphs/grch38+mm39.p70 -p 70 -D /scratch"
sbatch -c 96 -p tux -w tux09 --job-name pggb-human-mouse --wrap "hostname; $PGGB -i /lizardfs/guarracino/pggb-paper/assemblies/grch38+mm39.fa.gz -o /lizardfs/guarracino/pggb-paper/graphs/grch38+mm39.p70.k0 -p 70 -k 0 -P asm20 -D /scratch --input-paf /lizardfs/guarracino/pggb-paper/graphs/grch38+mm39.p70/grch38+mm39.fa.gz.707bd6e.alignments.wfmash.paf --resume"
```

SNVs evaluation with NUCMER:

```shell
mkdir -p $DIR_EVALUATIONS
cd $DIR_EVALUATIONS

zsh: no matches found: /lizardfs/guarracino/pggb-paper/graphs/athaliana82.chr2_p90.s10000.n82.k47.G700-900-1100.Pasm5.O0001_1/*.final.gfa 
sed '1d' $PATH_PANGENOMES_TSV | sort -k 4n | grep athaliana82 | grep 'chr1\|chr2' | while read f p s n k G POA O REF; do
  seq 1 1 | while read c; do
    echo $f $p $s $n $k $G $POA $O $REF $c;

    out=$(basename "$f" .fa.gz)_p$p.s$s.n$n.k$k.G$(echo $G | tr ',' '-').P$POA.O$(echo $O | sed 's/\.//g')_$c
    PATH_GFA=$DIR_GRAPHS/$out/*.final.gfa
    PATH_GFA=$(eval echo $PATH_GFA) # force '*' expansion
    sbatch -c $THREADS -p workers -J $(basename "$f" .fa.gz) --wrap "hostname; cd /scratch; $RUN_GFA_2_EVALUATION $PATH_GFA $REF $DIR_EVALUATIONS/$out $THREADS;"
  done
done

cd $DIR_EVALUATIONS

for type in "" "waved."; do
  echo $type

  # All results
  ((echo -n replicate"\t"dataset"\t"; cat */statistics*.tsv | head -n 1 | tr -d '\n'; echo -e "\tpggb.evaluated"); ls */statistics.haplo.${type}tsv | while read f; do name=$(echo $f | cut -f 1 -d '/'); sed '1d' $f | awk -v name=$name -v OFS='\t' '{ print(name,$0) }' | awk -v OFS='\t' '{print(substr($1, length($1), 1),$0,$4+$5)}'; done) | sort -k 1,1n -k 2,2> nucmer-based_evaluation.${type}tsv

  # Average results
  # GCA_028009825.1 and GCA_028009825.2 are identical, so they create nan in the evaluation
  grep 'GCA_028009825.2' -v nucmer-based_evaluation.${type}tsv |
    awk '
    BEGIN { FS=OFS="\t" }
    NR>1 {
        count[($1 FS $2)]++
        for (i=4; i<=NF; i++) {  # Start from the 4th column
            sum[($1 FS $2 FS i)] += $i
        }
    }
    END {
        print "replicate", "dataset", "tp.baseline", "tp.call", "fp", "fn", "precision", "recall", "f1.score", "nucmer.tot", "pggb.tot", "nucmer.ratio", "pggb.ratio", "pggb.evaluated"
        for (key in count) {
            printf "%s", key
            for (i=4; i<=15; i++) {  # Adjust the indices here as well
                printf "%s%.6f", OFS, sum[key FS i] / count[key]
            }
            print ""
        }
    }' | sort -k 1,1n -k 2,2 > nucmer-based_evaluation.${type}mean.tsv
done
```

SNVs and INDELs evaluation (TO DO ATHALIANA82 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx):
MAYBE ALSO SOY

```shell
# Call variants
cd $DIR_GRAPHS
sed '1d' $PATH_PANGENOMES_TSV | sort -k 4n | grep 'hsapiens\|tomato' | while read f p s n k G POA O REF; do
  seq 1 1 | while read c; do
    if [[ $f == *"hsapiens"* ]]; then
      REF="grch38"
    fi
    echo $f $p $s $n $k $G $POA $O $REF $c;

    out=$(basename "$f" .fa.gz)_p$p.s$s.n$n.k$k.G$(echo $G | tr ',' '-').P$POA.O$(echo $O | sed 's/\.//g')_$c
    PATH_GFA=$DIR_GRAPHS/$out/*.final.gfa
    PATH_GFA=$(eval echo $PATH_GFA) # force '*' expansion
    PREFIX=$(echo $PATH_GFA | sed 's/.gfa//g')

    sbatch -c $THREADS -p allnodes --job-name vg-$out --wrap "hostname; cd $DIR_GRAPHS/$out; vg deconstruct -P $REF -e -a -t $THREADS $PATH_GFA | bgzip -@ $THREADS -l 9 > $PREFIX.$REF.vcf.gz; vcfbub -l 0 -a 10000 --input $PREFIX.$REF.vcf.gz | vcfwave -I 1000 -t $THREADS > $PREFIX.$REF.decomposed.tmp.vcf; bcftools annotate -x INFO/TYPE $PREFIX.$REF.decomposed.tmp.vcf | awk '\$5 != \".\"' | bgzip -@ $THREADS -l 9 > $PREFIX.$REF.decomposed.vcf.gz; tabix $PREFIX.$REF.decomposed.vcf.gz; rm $PREFIX.$REF.decomposed.tmp.vcf"
  done
done

# HPRC
cut -f 1 /lizardfs/erikg/HPRC/year1v2genbank/evaluation/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna -d ' ' | sed 's/>chr/>grch38#1#chr/g' > $DIR_BASE/vcfs/hsapiens/grch38.fa
samtools faidx /lizardfs/guarracino/pggb-paper/vcfs/hsapiens/grch38.fa
rtg format -o $DIR_BASE/vcfs/hsapiens/grch38.fa.sdf $DIR_BASE/vcfs/hsapiens/grch38.fa

# From https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=submissions/B581EBA7-8BDE-4C7C-9DEA-78B99A051155--Yale_HPP_Year1_Variant_Calls/
mkdir -p $DIR_BASE/vcfs/hsapiens
cd $DIR_BASE/vcfs/hsapiens
cut -f 2 $DIR_BASE/data/HPRC.deepvariant-vcf.urls.tsv | parallel -j 4 'wget -q {} && echo got {}'

ls $DIR_BASE/vcfs/hsapiens/*vcf.gz | while read VCF; do
  echo $VCF
  NAME=$(basename $VCF .vcf.gz)
  zcat $VCF | sed 's/chr/grch38#1#chr/g' | bgzip -@ 48 -l 9 > $NAME.pansn.vcf.gz
  rm $VCF
  tabix $NAME.pansn.vcf.gz
done

# Confident regions
# From https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=working/HPRC/HG00438/assemblies/year1_freeze_assembly_v2/assembly_qc/dipcall_v0.2/
cut -f 2 $DIR_BASE/data/HPRC.dipcall-confident-regions.urls.tsv | parallel -j 4 'wget -q {} && echo got {}'

ls $DIR_BASE/vcfs/hsapiens/*bed | while read BED; do
  echo $BED
  NAME=$(basename $BED .bed)
  cat $BED | sed 's/chr/grch38#1#chr/g' | sort -V | bgzip -@ 48 -l 9 > $NAME.confident-yes.pansn.bed.gz
  rm $BED
  tabix -p bed $NAME.confident-yes.pansn.bed.gz

  bedtools complement -i $NAME.confident-yes.pansn.bed.gz -g <(cut -f 1,2 /lizardfs/guarracino/pggb-paper/vcfs/hsapiens/grch38.fa.fai | sort -V) | bgzip -@ 48 -l 9 > $NAME.confident-no.pansn.bed.gz
  tabix -p bed $NAME.confident-no.pansn.bed.gz
done


bash $DIR_BASE/scripts/evaluation.hsapiens90.chr6.sh $DIR_BASE/graphs/hsapiens90.chr6.masked_p95.s10000.n90.k47.G700-900-1100.Pasm5.O0001_1/hsapiens90.chr6.masked.fa.gz.a13a25f.e34d4cd.6cad134.smooth.final.grch38.vcf.gz hsapiens90.chr6.masked_p95.s10000.n90.k47.G700-900-1100.Pasm5.O0001_1 $DIR_BASE/evaluations_vcfeval


# Tomato
# Transfer VCF files from Google Drive to /lizardfs/guarracino/pggb-paper/vcfs/tomato
ls *vcf.gz | while read VCF; do
  SAMPLE=$(echo $VCF | cut -f 1 -d '.')
  echo $VCF $SAMPLE



done

SL5#1#ch02

```

Compression:

```shell
cd $DIR_GRAPHS

(echo "dataset graph.len pangenome.len compression.ratio" | tr ' ' '\t'; ls $DIR_GRAPHS/*/*.final.og | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)"
  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)
  PREFIX=$DIR_PARENT/$NAME

  GRAPH_LEN=$($ODGI stats -i $GRAPH -S | tail -n 1 | cut -f 1)
  PANGENOME_LEN=$(cat $(grep Command $DIR_PARENT/*.log | cut -f 4 -d ' ').fai | awk '{sum+=$2}END{print(sum)}')
  echo $NAME $GRAPH_LEN $PANGENOME_LEN | awk -v OFS='\t' '{print($0,$3/$2)}'
done) > compression.stats.tsv
```

Openness:

```shell
ls $DIR_GRAPHS/*/*gfa | grep athaliana -v | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)"
  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)
  PREFIX=$DIR_PARENT/$NAME
  #NUM=$(echo $NAME | cut -f 1 -d '.' | grep -oP '\d+$')
  echo $PREFIX
  sbatch -c 48 -p tux --job-name panacus-$NAME --wrap "hostname; $PANACUS histgrowth $GRAPH -c bp -q 0,1,0.5,0.1 --groupby-sample -t 48 > $PREFIX.histgrowth.tsv; $PANACUS_VISUALIZE --estimate_growth_params $PREFIX.histgrowth.tsv -s 15 10 > $PREFIX.histgrowth.pdf"
done
```

Visualization by merging contigs by haplotype:

```shell
cd $DIR_BASE

ls $DIR_GRAPHS/*/*.final.og | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)"
  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)
  PREFIX=$DIR_PARENT/$NAME
  echo $NAME

  if [[ ! -s $PREFIX.prefixes.txt ]]; then
    $ODGI paths -i $GRAPH -L | cut -f 1,2 -d '#' | sort | uniq > $PREFIX.prefixes.txt
  fi
  
  sbatch -c 8 -p workers -J $NAME-N  --wrap "hostname; $ODGI viz -i $GRAPH -o $PREFIX.merged_by_haplotype.N.png  -x 1000 -y 500 -a 10 -N  -I Consensus_ -M $PREFIX.prefixes.txt"
  sbatch -c 8 -p workers -J $NAME-z  --wrap "hostname; $ODGI viz -i $GRAPH -o $PREFIX.merged_by_haplotype.z.png  -x 1000 -y 500 -a 10 -z  -I Consensus_ -M $PREFIX.prefixes.txt"
  sbatch -c 8 -p workers -J $NAME-du --wrap "hostname; $ODGI viz -i $GRAPH -o $PREFIX.merged_by_haplotype.du.png -x 1000 -y 500 -a 10 -du -I Consensus_ -M $PREFIX.prefixes.txt"
done
```

### Primates

1D visualization:

```shell
cd $DIR_BASE

ls $DIR_GRAPHS/primates16.hsa6_p9*/*final.og | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)"
  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)

  PREFIX=$DIR_PARENT/$NAME

  sbatch -c 48 -p workers --job-name $NAME --wrap "hostname; echo chm13#1#chr6 > $NAME.sort_by_ref.txt; $ODGI sort -i $GRAPH -t $THREADS -o $PREFIX.Ygs.sort_by_ref.og -p Ygs -H $NAME.sort_by_ref.txt -x 300 --temp-dir /scratch -P; $ODGI inject -i $PREFIX.Ygs.sort_by_ref.og -b $DIR_BASE/data/chr6.annotations.bed -o $PREFIX.Ygs.sort_by_ref.inject.og -t $THREADS -P; $ODGI paths -i $PREFIX.Ygs.sort_by_ref.inject.og -L | cut -f 1,2 -d '#' | sort | uniq > $PREFIX.Ygs.sort_by_ref.inject.prefixes.txt; $ODGI viz -i $PREFIX.Ygs.sort_by_ref.inject.og -o $PREFIX.Ygs.sort_by_ref.inject.merged_by_haplotype.z.png -x 1500 -y 500 -a 10 -z -I Consensus_ -M $PREFIX.Ygs.sort_by_ref.inject.prefixes.txt; $ODGI viz -i $PREFIX.Ygs.sort_by_ref.inject.og -o $PREFIX.Ygs.sort_by_ref.inject.merged_by_haplotype.du.png -x 1500 -y 500 -a 10 -du -I Consensus_ -M $PREFIX.Ygs.sort_by_ref.inject.prefixes.txt"
done
```

2D visualization (layout):

```shell
cd $DIR_BASE

ls $DIR_GRAPHS/primates16.hsa6_p9*/*final.og | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)"
  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)

  PREFIX=$DIR_PARENT/$NAME.x300.G20.I10000.l1000.Nh
  sbatch -c 48 -p workers -J $NAME --wrap "hostname; $ODGI layout -i $GRAPH -x 300 -G 20 -I 10000 -l 1000 -N h -o $PREFIX.lay -T $PREFIX.lay.tsv -t 48 -P --temp-dir /scratch/; $ODGI draw -i $GRAPH -c $PREFIX.lay -p $PREFIX.2D.png"

  PREFIX=$DIR_PARENT/$NAME.Ng
  sbatch -c 48 -p workers -J $NAME --wrap "hostname; $ODGI layout -i $GRAPH -N g -o $PREFIX.lay -T $PREFIX.lay.tsv -t 48 -P --temp-dir /scratch/; $ODGI draw -i $GRAPH -c $PREFIX.lay -p $PREFIX.2D.png"

  PREFIX=$DIR_PARENT/$NAME.x100.Ng
  sbatch -c 48 -p workers -J $NAME --wrap "hostname; $ODGI layout -i $GRAPH -N g -x 100 -o $PREFIX.lay -T $PREFIX.lay.tsv -t 48 -P --temp-dir /scratch/; $ODGI draw -i $GRAPH -c $PREFIX.lay -p $PREFIX.2D.png"
done

ls $DIR_GRAPHS/primates16.hsa6_p95.s10000.n16.k*/*.og | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)"
  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)

  PREFIX=$DIR_PARENT/$NAME.x1500.G20.I10000.l1000.Nh
  echo "$ODGI layout -i $GRAPH -x 1500 -G 20 -I 10000 -l 1000 -N h -o $PREFIX.lay -T $PREFIX.lay.tsv -t 96 -P --temp-dir /home/guarracino && $ODGI draw -i $GRAPH -c $PREFIX.lay -p $PREFIX.2D.png"
done

Command being timed: "/lizardfs/guarracino/tools/odgi/bin/odgi-861b1c04f5622c5bb916a161c1abe812c213f1a5 layout -i /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s5000.n16.k79.G700-900-1100.Pasm5.O0001_1/primates16.hsa6.fa.gz.35d2267.c2fac19.552bc22.smooth.final.og -x 1500 -G 20 -I 10000 -l 1000 -N h -o /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s5000.n16.k79.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s5000.n16.k79.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay -T /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s5000.n16.k79.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s5000.n16.k79.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay.tsv -t 96 -P --temp-dir /home/guarracino"
User time (seconds): 8829141.26
System time (seconds): 1003.11
Percent of CPU this job got: 9342%
Elapsed (wall clock) time (h:mm:ss or m:ss): 26:15:12
Average shared text size (kbytes): 0
Average unshared data size (kbytes): 0
Average stack size (kbytes): 0
Average total size (kbytes): 0
Maximum resident set size (kbytes): 27020940
Average resident set size (kbytes): 0
Major (requiring I/O) page faults: 86
Minor (reclaiming a frame) page faults: 4725762
Voluntary context switches: 203251679
Involuntary context switches: 123201461
Swaps: 0
File system inputs: 0
File system outputs: 43549616
Socket messages sent: 0
Socket messages received: 0
Signals delivered: 0
Page size (bytes): 4096
Exit status: 0

Command being timed: "/lizardfs/guarracino/tools/odgi/bin/odgi-861b1c04f5622c5bb916a161c1abe812c213f1a5 layout -i /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s5000.n16.k47.G700-900-1100.Pasm5.O0001_1/primates16.hsa6.fa.gz.35d2267.e34d4cd.552bc22.smooth.final.og -x 1500 -G 20 -I 10000 -l 1000 -N h -o /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s5000.n16.k47.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s5000.n16.k47.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay -T /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s5000.n16.k47.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s5000.n16.k47.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay.tsv -t 96 -P --temp-dir /home/guarracino"
User time (seconds): 10130657.37
System time (seconds): 1508.12
Percent of CPU this job got: 9300%
Elapsed (wall clock) time (h:mm:ss or m:ss): 30:15:47
Average shared text size (kbytes): 0
Average unshared data size (kbytes): 0
Average stack size (kbytes): 0
Average total size (kbytes): 0
Maximum resident set size (kbytes): 30711708
Average resident set size (kbytes): 0
Major (requiring I/O) page faults: 90
Minor (reclaiming a frame) page faults: 5366331
Voluntary context switches: 228020401
Involuntary context switches: 142916173
Swaps: 0
File system inputs: 0
File system outputs: 49650136
Socket messages sent: 0
Socket messages received: 0
Signals delivered: 0
Page size (bytes): 4096
Exit status: 0

Command being timed: "/lizardfs/guarracino/tools/odgi/bin/odgi-861b1c04f5622c5bb916a161c1abe812c213f1a5 layout -i /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s10000.n16.k79.G700-900-1100.Pasm5.O0001_1/primates16.hsa6.fa.gz.a13a25f.c2fac19.552bc22.smooth.final.og -x 1500 -G 20 -I 10000 -l 1000 -N h -o /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s10000.n16.k79.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s10000.n16.k79.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay -T /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s10000.n16.k79.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s10000.n16.k79.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay.tsv -t 96 -P --temp-dir /home/guarracino"
User time (seconds): 8750334.59
System time (seconds): 863.28
Percent of CPU this job got: 9340%
Elapsed (wall clock) time (h:mm:ss or m:ss): 26:01:29
Average shared text size (kbytes): 0
Average unshared data size (kbytes): 0
Average stack size (kbytes): 0
Average total size (kbytes): 0
Maximum resident set size (kbytes): 26821812
Average resident set size (kbytes): 0
Major (requiring I/O) page faults: 59
Minor (reclaiming a frame) page faults: 4647449
Voluntary context switches: 201583953
Involuntary context switches: 111289241
Swaps: 0
File system inputs: 0
File system outputs: 42174400
Socket messages sent: 0
Socket messages received: 0
Signals delivered: 0
Page size (bytes): 4096
Exit status: 0

Command being timed: "/lizardfs/guarracino/tools/odgi/bin/odgi-861b1c04f5622c5bb916a161c1abe812c213f1a5 layout -i /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s10000.n16.k47.G700-900-1100.Pasm5.O0001_1/primates16.hsa6.fa.gz.a13a25f.e34d4cd.552bc22.smooth.final.og -x 1500 -G 20 -I 10000 -l 1000 -N h -o /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s10000.n16.k47.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s10000.n16.k47.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay -T /lizardfs/guarracino/pggb-paper/graphs/primates16.hsa6_p95.s10000.n16.k47.G700-900-1100.Pasm5.O0001_1/primates16.hsa6_p95.s10000.n16.k47.G700-900-1100.Pasm5.O0001_1.x1500.G20.I10000.l1000.Nh.lay.tsv -t 96 -P --temp-dir /home/guarracino"
User time (seconds): 10177164.43
System time (seconds): 1343.41
Percent of CPU this job got: 9302%
Elapsed (wall clock) time (h:mm:ss or m:ss): 30:23:35
Average shared text size (kbytes): 0
Average unshared data size (kbytes): 0
Average stack size (kbytes): 0
Average total size (kbytes): 0
Maximum resident set size (kbytes): 30354692
Average resident set size (kbytes): 0
Major (requiring I/O) page faults: 70
Minor (reclaiming a frame) page faults: 5119534
Voluntary context switches: 227223791
Involuntary context switches: 130601108
Swaps: 0
File system inputs: 0
File system outputs: 42605192
Socket messages sent: 0
Socket messages received: 0
Signals delivered: 0
Page size (bytes): 4096
Exit status: 0


cd $DIR_GRAPHS/primates16.hsa6_p95.s5000.n16.k47.G700-900-1100.Pasm5.O0001_1
GFA=$(eval echo *final.gfa)
NAME=$(basename $GFA .gfa)
grep '^P' -v $GFA > $NAME.chm13.gfa
grep 'chm13' $GFA >> $NAME.chm13.gfa

zstd -12 $NAME.chm13.gfa
TSV=$(eval echo *x1500.G20.I10000.l1000.Nh.lay.tsv)
pigz -9 $TSV
rm $NAME.chm13.gfa
```

MHC:

```shell
cd $DIR_BASE
LOCUS=MHC
ls $DIR_GRAPHS/primates16.hsa6_p9*/*.final.og | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)/$LOCUS"
  mkdir -p $DIR_PARENT

  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)
  echo $NAME

  $ODGI extract -i $GRAPH -b $DIR_BASE/data/primates16.MHC.bed -o - -O -t 48 -P | $ODGI sort -i - -o $DIR_PARENT/$NAME.$LOCUS.og -p gYs -x 1500 -t 48 -P --temp-dir /scratch/
  
  $ODGI flip -i $DIR_PARENT/$NAME.$LOCUS.og -o $DIR_PARENT/$NAME.$LOCUS.flip.og -t 1
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.flip.og -o $DIR_PARENT/$NAME.$LOCUS.flip.z.png -z -c 64 -x 1500
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.flip.og -o $DIR_PARENT/$NAME.$LOCUS.flip.m.png -m -B Spectral:4 -c 64 -x 1500

  $ODGI sort -i $DIR_PARENT/$NAME.$LOCUS.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.og -p gYs -H <(odgi paths -i $DIR_PARENT/$NAME.$LOCUS.og -L | grep grch38) -x 1500 -t 48 -P --temp-dir /scratch/
  $ODGI flip -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.og -t 1
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.z.png -z -c 64 -x 1500
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.m.png -m -B Spectral:4 -c 64 -x 1500

  $ODGI layout -i $DIR_PARENT/$NAME.$LOCUS.og -o $DIR_PARENT/$NAME.$LOCUS.lay -T $DIR_PARENT/$NAME.$LOCUS.lay.tsv -t 48 -x 300 -P --temp-dir /scratch
  $ODGI draw -i $DIR_PARENT/$NAME.$LOCUS.og -c $DIR_PARENT/$NAME.$LOCUS.lay -p $DIR_PARENT/$NAME.$LOCUS.2D.png
  $ODGI view -i $DIR_PARENT/$NAME.$LOCUS.og -g > $DIR_PARENT/$NAME.$LOCUS.gfa
done
```

C4:

```shell
cd $DIR_BASE

wget http://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.chrom.sizes
wget https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/genes/hg38.ncbiRefSeq.gtf.gz
zgrep 'gene_id "C4A"\|gene_id "C4B"' hg38.ncbiRefSeq.gtf.gz |
  awk '$1 == "chr6"' | cut -f 1,4,5 |
  bedtools sort | bedtools merge -d 15000 | bedtools slop -l 10000 -r 20000 -g hg38.chrom.sizes |
  sed 's/chr6/grch38#1#chr6/g' > hg38.ncbiRefSeq.C4.bed

wget https://raw.githubusercontent.com/pangenome/odgi/master/test/chr6.C4.bed
sed 's/^grch38/grch38#1/g' chr6.C4.bed -i

LOCUS=C4
mkdir /scratch/$LOCUS
ls $DIR_GRAPHS/primates16.hsa6_p9*/*.final.og | while read GRAPH; do
  DIR_PARENT="$(dirname $GRAPH)/$LOCUS"
  mkdir -p $DIR_PARENT

  NAME=$(echo $GRAPH | rev | cut -f 2 -d '/' | rev)
  echo $NAME

  $ODGI extract -i $GRAPH -b hg38.ncbiRefSeq.C4.bed -o - -O -t 48 -P | $ODGI sort -i - -o $DIR_PARENT/$NAME.$LOCUS.og -p gYs -x 1500 -t 48 -P --temp-dir /scratch/$LOCUS
  
  $ODGI flip -i $DIR_PARENT/$NAME.$LOCUS.og -o $DIR_PARENT/$NAME.$LOCUS.flip.og -t 1
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.flip.og -o $DIR_PARENT/$NAME.$LOCUS.flip.z.png -z -c 64 -x 1500
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.flip.og -o $DIR_PARENT/$NAME.$LOCUS.flip.m.png -m -B Spectral:4 -c 64 -x 1500

  $ODGI sort -i $DIR_PARENT/$NAME.$LOCUS.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.og -p gYs -H <(odgi paths -i $DIR_PARENT/$NAME.$LOCUS.og -L | grep grch38) -x 300 -t 48 -P --temp-dir /scratch/$LOCUS
  $ODGI flip -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.og -t 1
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.z.png -z -c 64 -x 1500
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.flip.m.png -m -B Spectral:4 -c 64 -x 1500

  $ODGI procbed -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.og -b chr6.C4.bed > $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.C4.adj.bed
  $ODGI inject -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.og -b $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.C4.adj.bed -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.inject.og
  $ODGI flip -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.inject.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.inject.flip.og -t 1
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.inject.flip.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.inject.flip.z.png -z -c 64 -x 1500
  $ODGI viz -i $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.inject.flip.og -o $DIR_PARENT/$NAME.$LOCUS.sort-by-ref.inject.flip.m.png -m -B Spectral:4 -c 64 -x 1500

  $ODGI layout -i $DIR_PARENT/$NAME.$LOCUS.og -o $DIR_PARENT/$NAME.$LOCUS.lay -T $DIR_PARENT/$NAME.$LOCUS.lay.tsv -t 48 -x 1500 -P --temp-dir /scratch/$LOCUS
  $ODGI draw -i $DIR_PARENT/$NAME.$LOCUS.og -c $DIR_PARENT/$NAME.$LOCUS.lay -p $DIR_PARENT/$NAME.$LOCUS.2D.png
  $ODGI view -i $DIR_PARENT/$NAME.$LOCUS.og -g > $DIR_PARENT/$NAME.$LOCUS.gfa
done
rm /scratch/$LOCUS -rf
```

## Notes

To remember that we are still doing this (both in PGGB and in GFA2EVALUATION) because of bugs in `vcfwave`:

```shell
# The TYPE info sometimes is wrong/missing
# There are variants without the ALT allele
bcftools annotate -x INFO/TYPE "$PATH_WAVED_VCF".gz  | awk '$5 != "."' | bgzip -@ THREADS -c > "$PATH_WAVED_FIXED_VCF".gz
```


## Minigraph Cactus

The first sample in `*.seqfile` is used to anchor the entire graph (https://github.com/ComparativeGenomicsToolkit/cactus/blob/master/doc/pangenome.md#sample-names).

Prepare the input:

```shell
cd $DIR_BASE

sed '1d' $PATH_PANGENOMES_TSV | grep athaliana82 | cut -f 1 -d ' ' | sort | uniq | while read PATH_FASTA; do
  DIR_PANGENOME="$(dirname $PATH_FASTA)"

  >&2 echo $DIR_PANGENOME $PATH_FASTA

  cut -f 1 $PATH_FASTA.fai | sort -k 2,2n | cut -f 1,2 -d '#' | sort | uniq | while read ACC; do
    ACC2=$(echo $ACC | tr '#' '_')

    if [[ "$ACC" == "chm13#1" ]] || [[ "$ACC" == "grch38#1" ]]; then
        ACC3="${ACC%#*}"
    else
        ACC3="$(echo $ACC | tr '#' '.')"
    fi

    #samtools faidx $PATH_FASTA $(cut -f 1 $PATH_FASTA.fai | grep $ACC) | bgzip -l 9 -@ 48 > $DIR_PANGENOME/$ACC2.fasta.gz
    #samtools faidx $DIR_PANGENOME/$ACC2.fasta.gz
    echo $ACC3 $DIR_PANGENOME/$ACC2.fasta.gz | tr ' ' '\t'
  done > $DIR_PANGENOME/$(basename $PATH_FASTA .fa.gz).seqfile
done

# MC will partition the assemblies by chromosome
cd $DIR_BASE/assemblies/athaliana
mv athaliana82.chr1.seqfile athaliana82.seqfile
rm athaliana82.chr2.seqfile athaliana82.chr3.seqfile athaliana82.chr4.seqfile athaliana82.chr5.seqfile
cd $DIR_BASE

# Fix references
reorder_seqfile() {
    local seqfile=$1
    local ref=$2
    local temp_file="temp_seqfile"

    grep "$ref" "$seqfile" > "$temp_file"
    grep "$ref" "$seqfile" -v >> "$temp_file"
    mv "$temp_file" "$seqfile"
}
reorder_seqfile "$DIR_BASE/assemblies/primates/primates16.hsa6.seqfile" "grch38"
reorder_seqfile "$DIR_BASE/assemblies/tomato/tomato23.chr2.seqfile" "SL5"
reorder_seqfile "$DIR_BASE/assemblies/ecoli/ecoli50.seqfile" "GCA_000597845.1"
reorder_seqfile "$DIR_BASE/assemblies/ecoli/ecoli500.seqfile" "GCA_000597845.1"
reorder_seqfile "$DIR_BASE/assemblies/scerevisiae/scerevisiae142.seqfile" "SGDref"
reorder_seqfile "$DIR_BASE/assemblies/athaliana/athaliana82.seqfile" "GCA_028009825.1"


# On lambda01
mkdir -p $DIR_GRAPHS_MC
cd $DIR_GRAPHS_MC

fmt="%C\n%Us user %Ss system %P cpu %es total %MKb max memory"
export PATH=/lizardfs/guarracino/tools/cactus-bin-v2.7.0/bin:$PATH
source /lizardfs/guarracino/tools/cactus-bin-v2.7.0/venv-cactus-v2.7.0/bin/activate

sed '1d' $PATH_PANGENOMES_TSV | grep athaliana82 -v | cut -f 1 -d ' ' | sort | uniq | while read PATH_FASTA; do
  DIR_PANGENOME="$(dirname $PATH_FASTA)"
  PATH_SEQFILE=$DIR_PANGENOME/$(basename $PATH_FASTA .fa.gz).seqfile
  REF=$(head $PATH_SEQFILE -n 1 | cut -f 1)

  >&2 echo $PATH_SEQFILE $REF
  echo sbatch -c 48 -p 386mem --job-name MC-$(basename $PATH_SEQFILE .seqfile) --wrap "hostname; cd /scratch; \time -f $fmt cactus-pangenome ./$(basename $PATH_FASTA .fa.gz)-js $PATH_SEQFILE --outDir $(basename $PATH_FASTA .fa.gz) --outName $(basename $PATH_FASTA .fa.gz) --reference $REF --vcf --giraffe --gfa --gbz --maxCores 48 --batchSystem single_machine --defaultCores 48 --vcfReference $REF --noSplit 2>&1 | tee $(basename $PATH_FASTA .fa.gz).MC.log; mv $(basename $PATH_FASTA .fa.gz)* $DIR_GRAPHS_MC"
done









DIR_PANGENOME=/lizardfs/guarracino/pggb-paper/assemblies/athaliana
cut -f 1 $DIR_PANGENOME/athaliana82.fa.gz.fai| cut -f 1 -d '#' | sort | uniq | while read ACC; do echo $ACC; samtools faidx $DIR_PANGENOME/athaliana82.fa.gz $(cut -f 1 $DIR_PANGENOME/athaliana82.fa.gz.fai | grep $ACC) | bgzip -l 9 -@ 48 > $DIR_PANGENOME/$ACC.fasta.gz; samtools faidx $DIR_PANGENOME/$ACC.fasta.gz; done
rm Atha82.joblist
ls $DIR_PANGENOME/*fasta.gz | while read FASTA; do ACC=$(basename $FASTA .fasta.gz | cut -f 1,2 -d '_' | tr '.' '_'); echo "$ACC\t$FASTA" >> Atha82.joblist; done 

#!/bin/bash
fmt="%C\n%Us user %Ss system %P cpu %es total %MKb max memory"
export PATH=/lizardfs/guarracino/tools/cactus-bin-v2.7.0/bin:$PATH
source /lizardfs/guarracino/tools/cactus-bin-v2.7.0/venv-cactus-v2.7.0/bin/activate
/usr/bin/time -f $fmt cactus-pangenome ./js Atha82.joblist --outDir At82_MC --outName At82_MC --reference GCA_000001735_2 GCA_028009825_1 GCA_028009825_2 --vcf --giraffe --gfa --gbz --maxCores 224 --batchSystem single_machine --defaultCores 64 --vcfReference GCA_000001735_2 GCA_028009825_1 GCA_028009825_2
[2023-12-07T21:37:18+0000] [MainThread] [I] [toil.statsAndLogging] cactus-pangenome has finished after 89085.42339792382 seconds
2466690.39s user 69531.40s system 2846% cpu 89094.36s total 149417484Kb max memory

DIR_PANGENOME=/lizardfs/guarracino/pggb-paper/assemblies/primates
cut -f 1 $DIR_PANGENOME/primates16.hsa6.fa.gz.fai| cut -f 1 -d '#' | sort | uniq | while read ACC; do echo $ACC; samtools faidx $DIR_PANGENOME/primates16.hsa6.fa.gz $(cut -f 1 $DIR_PANGENOME/primates16.hsa6.fa.gz.fai | grep $ACC) | bgzip -l 9 -@ 48 > $DIR_PANGENOME/$ACC.hsa6.fasta.gz; samtools faidx $DIR_PANGENOME/$ACC.hsa6.fasta.gz; done
rm primates16.hsa6.joblist
ls $DIR_PANGENOME/*.hsa6.fasta.gz | while read FASTA; do ACC=$(basename $FASTA .fasta.gz | cut -f 1,2 -d '_' | tr '.' '_'); echo "$ACC\t$FASTA" >> primates16.hsa6.joblist; done 
[2023-12-07T08:28:49+0000] [MainThread] [I] [toil.statsAndLogging] cactus-pangenome has finished after 14534.32546418719 seconds
39138.20s user 7334.40s system 319% cpu 14536.33s total 57772840Kb max memory  

#!/bin/bash
fmt="%C\n%Us user %Ss system %P cpu %es total %MKb max memory"
export PATH=/lizardfs/guarracino/tools/cactus-bin-v2.7.0/bin:$PATH
source /lizardfs/guarracino/tools/cactus-bin-v2.7.0/venv-cactus-v2.7.0/bin/activate
/usr/bin/time -f $fmt cactus-pangenome ./js-primates16.hsa6 primates16.hsa6.joblist --outDir primates16.hsa6_MC --outName primates16.hsa6_MC --reference grch38_hsa6 --vcf --giraffe --gfa --gbz --maxCores 32 --batchSystem single_machine --defaultCores 8 --vcfReference grch38_hsa6
/usr/bin/time -f $fmt cactus-pangenome ./js-primates16.hsa6-no-split primates16.hsa6.joblist --outDir primates16.hsa6_MC-no-split --outName primates16.hsa6_MC-no-split --reference grch38_hsa6 --vcf --giraffe --gfa --gbz --maxCores 32 --batchSystem single_machine --defaultCores 8 --vcfReference grch38_hsa6 --noSplit
[2023-12-07T19:34:41+0000] [MainThread] [I] [toil.statsAndLogging] cactus-pangenome has finished after 14368.12507063197 seconds
36943.98s user 7407.71s system 308% cpu 14372.01s total 57775112Kb max memory
```

## PGGB with/without smoothxg

```shell
/home/guarracino/tools/seqwish/bin/seqwish-f44b402f0c2e02988d431d9b2e5eba9727cf93a9 -s /lizardfs/guarracino/pggb-paper/assemblies/hsapiens/hsapiens90.chr6.masked.fa.gz -p hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1/hsapiens90.chr6.masked.fa.gz.445f03b.alignments.wfmash.paf -k 47 -f 0 -g hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1/hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.gfa -B 10000000 -t 32 --temp-dir /scratch/ -P

/home/guarracino/tools/seqwish/bin/seqwish-f44b402f0c2e02988d431d9b2e5eba9727cf93a9 -s /lizardfs/guarracino/pggb-paper/assemblies/hsapiens/hsapiens90.chr6.masked.fa.gz -p hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1/hsapiens90.chr6.masked.fa.gz.445f03b.alignments.wfmash.paf -k 0 -f 0 -g hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1/hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.gfa -B 10000000 -t 32 --temp-dir /scratch/ -P


ls *gfa | grep '\.k' | while read GRAPH; do echo $GRAPH; odgi build -g $GRAPH -o $(basename $GRAPH .gfa).og -t 32; done  

ls *og | while read GRAPH; do echo $GRAPH; odgi stats -i $GRAPH -S; done       

#graph                                                                             length          nodes   edges   paths   steps
hsapiens90.chr6.masked.fa.gz.445f03b.e34d4cd.80ba7c5.smooth.final                  212423296       4531659 6502016 1410    476956630
hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0   209420591       4370279 6148746 1410    651527277
hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47  213486647       4053815 5636679 1410    584533180


GRAPH=chr6.C4.gfa
NAME=$(basename $graph .gfa)
PREFIX_REF=chm13

odgi paths -i hsapiens90.chr6.masked.fa.gz.445f03b.e34d4cd.80ba7c5.smooth.final.og -Ll | grep chm13 | awk -v OFS='\t' '{print($1,$2-1,$3)}' | bedtools makewindows -b /dev/stdin -w 10000 > hsapiens90.chr6.masked.chm13.windows.10kbp.bed

odgi depth -i $GRAPH -b hsapiens90.chr6.masked.chm13.windows.10kbp.bed | bedtools sort > xxx
odgi degree -i $GRAPH -b hsapiens90.chr6.masked.chm13.windows.10kbp.bed | bedtools sort > xxx
odgi degree -i $GRAPH -d > xxx.tsv









$ODGI extract -i hsapiens90.chr6.masked.fa.gz.445f03b.e34d4cd.80ba7c5.smooth.final.og -b ../../hg38.ncbiRefSeq.C4.bed -o hsapiens90.chr6.masked.fa.gz.445f03b.e34d4cd.80ba7c5.smooth.final.C4.og -t 48 -P -O
$ODGI extract -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.gfa -b ../../hg38.ncbiRefSeq.C4.bed -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.og -t 48 -P -O
$ODGI extract -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.gfa -b ../../hg38.ncbiRefSeq.C4.bed -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.og -t 48 -P -O


$ODGI viz -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.og -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.unsorted.png -m -B Spectral:4
$ODGI sort -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.og -p gYs -o - -P -t 10 --temp-dir /scratch | $ODGI viz -i hsapiens90.chr6.masked.fa.gz.445f03b.e34d4cd.80ba7c5.smooth.final.C4.og -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.png -m -B Spectral:4

$ODGI viz -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.og -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.unsorted.png -m -B Spectral:4
$ODGI sort -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.og -p gYs -o - -P -t 10 --temp-dir /scratch | $ODGI viz -i hsapiens90.chr6.masked.fa.gz.445f03b.e34d4cd.80ba7c5.smooth.final.C4.og -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.png -m -B Spectral:4


$ODGI layout -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.og -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.lay --temp-dir /scratch -t 48 -P
$ODGI draw -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.og -c hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.lay -p hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.C4.2D.png

$ODGI layout -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.og -o hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.lay --temp-dir /scratch -t 48 -P
$ODGI draw -i hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.og -c hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.lay -p hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.C4.2D.png

ls *C4*.og | while read f; do echo $f; odgi stats -i $f -S; done

# quantify the runtime and memory too for odgi build/extract/sort?
# we would need to find a locus where -k 47 lead to underalignment and one where -k 0 lead to overalignment



cd $DIR_EVALUATIONS
GFA=/lizardfs/guarracino/pggb-paper/graphs/hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1/hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k47.gfa
sbatch -c 48 -p workers -J hsapiens90.chr6.masked --wrap "hostname; cd /scratch; /lizardfs/guarracino/pggb-paper/scripts/gfa2evaluation.sh $GFA chm13 /lizardfs/guarracino/pggb-paper/evaluations/hsapiens90.chr6.masked_p98.s5000.n90.k79.G700-900-1100.Pasm5.O0001_1.seqwish.k47.gfa 48;"

GFA=/lizardfs/guarracino/pggb-paper/graphs/hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1/hsapiens90.chr6.masked_p98.s20000.n90.k47.G700-900-1100.Pasm5.O0001_1.seqwish.k0.gfa
sbatch -c 48 -p workers -J hsapiens90.chr6.masked --wrap "hostname; cd /scratch; /lizardfs/guarracino/pggb-paper/scripts/gfa2evaluation.sh $GFA chm13 /lizardfs/guarracino/pggb-paper/evaluations/hsapiens90.chr6.masked_p98.s5000.n90.k79.G700-900-1100.Pasm5.O0001_1.seqwish.k0.gfa 48;"
```
